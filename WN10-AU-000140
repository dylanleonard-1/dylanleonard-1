# Configuring 'Audit Security State Change' Policy (STIG ID: WN10-AU-000140)

## **Overview**
This guide provides step-by-step instructions and an automated PowerShell script to configure the **Audit Security State Change** policy in Windows. This policy ensures that security-related state changes are logged with "Success" auditing enabled, in compliance with **STIG ID: WN10-AU-000140**.

---

## **Steps for Configuration**

### **Step 1: Check Current Configuration**
Run the following command to verify the current audit policy setting:
```powershell
auditpol /get /subcategory:"Security State Change"
```
- If the output shows **No Auditing**, proceed to configure the policy.

---

### **Step 2: Enable Success Auditing**
To enable **Success** auditing for **Security State Change**, execute the following command:
```powershell
auditpol /set /subcategory:"Security State Change" /success:enable
```

---

### **Step 3: Verify the Configuration**
Run the following command again to confirm the changes:
```powershell
auditpol /get /subcategory:"Security State Change"
```
Ensure the output shows:
```
Security State Change                   Success
```

---

## **Unified PowerShell Script**
The following PowerShell script automates the configuration and verification process:

```powershell
<#
.SYNOPSIS
Configures 'Audit Security State Change' policy to enable Success auditing.

.DESCRIPTION
This script automates the configuration of the audit policy for 'Security State Change' and logs the process for verification.

.NOTES
Author: [Your Name]
STIG ID: WN10-AU-000140
#>

# Define the log file path
$logFilePath = "$env:TEMP\AuditPolicyConfiguration.log"

# Log initialization
Write-Output "Initializing log..." | Out-File -FilePath $logFilePath

# Verify current setting
Write-Output "Checking current audit policy for 'Security State Change'..." | Tee-Object -FilePath $logFilePath -Append
$currentSetting = auditpol /get /subcategory:"Security State Change"
$currentSetting | Tee-Object -FilePath $logFilePath -Append

if ($currentSetting -match "No Auditing") {
    Write-Output "'Security State Change' is not configured. Enabling Success auditing..." | Tee-Object -FilePath $logFilePath -Append

    # Enable Success auditing
    auditpol /set /subcategory:"Security State Change" /success:enable

    # Verify changes
    $updatedSetting = auditpol /get /subcategory:"Security State Change"
    $updatedSetting | Tee-Object -FilePath $logFilePath -Append

    if ($updatedSetting -match "Success") {
        Write-Output "Configuration successful: 'Security State Change' is now set to Success auditing." | Tee-Object -FilePath $logFilePath -Append
    } else {
        Write-Warning "Failed to configure 'Security State Change'. Please check manually." | Tee-Object -FilePath $logFilePath -Append
    }
} else {
    Write-Output "'Security State Change' is already configured correctly." | Tee-Object -FilePath $logFilePath -Append
}

Write-Output "Audit policy configuration process complete. Log saved at: $logFilePath"
```

---

## **Execution Instructions**
1. Save the script as `ConfigureSecurityStateChange.ps1`.
2. Open PowerShell as **Administrator**.
3. Run the script:
   ```powershell
   .\ConfigureSecurityStateChange.ps1
   ```

---

## **Troubleshooting**

### **1. Check Group Policy Overrides**
If the setting remains as **No Auditing**, a Group Policy Object (GPO) might be overriding the local configuration.

#### **Generate a Group Policy Result Report**
Run:
```powershell
gpresult /h "$env:TEMP\gpresult.html"
start "$env:TEMP\gpresult.html"
```
Review the report for GPOs affecting **Advanced Audit Policy Configuration**.

#### **Manually Configure with Group Policy Editor**
1. Open `gpedit.msc`.
2. Navigate to:
   ```
   Computer Configuration > Windows Settings > Security Settings > Advanced Audit Policy Configuration > System Audit Policies > System > Audit Security State Change
   ```
3. Enable **Success**.

---

### **2. Review Logs**
Check the log file generated by the script for detailed steps and any errors:
```powershell
notepad "$env:TEMP\AuditPolicyConfiguration.log"
```

---

## **Resources**
- [Microsoft Documentation: Auditpol Command](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/auditpol)
- [STIG Viewer for Compliance Validation](https://public.cyber.mil/stigs/)

